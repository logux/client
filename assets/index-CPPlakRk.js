(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();let T=()=>({emit(i,...e){for(let t=0,s=this.events[i]||[],n=s.length;t<n;t++)s[t](...e)},events:{},on(i,e){var t;return((t=this.events)[i]||(t[i]=[])).push(e),()=>{var s;this.events[i]=(s=this.events[i])==null?void 0:s.filter(n=>e!==n)}}});class w extends Error{constructor(e,t,s){super(e),this.name="LoguxError",this.type=e,this.options=t,this.description=w.describe(e,t),this.received=!!s,s?(this.message="Logux received "+this.type+" error",this.description!==this.type&&(this.message+=" ("+this.description+")")):this.message=this.description,Error.captureStackTrace&&Error.captureStackTrace(this,w)}static describe(e,t){return e==="timeout"?"A timeout was reached ("+t+" ms)":e==="wrong-format"?"Wrong message format in "+t:e==="unknown-message"?"Unknown message `"+t+"` type":e==="bruteforce"?"Too many wrong authentication attempts":e==="wrong-protocol"?`Logux supports protocols only from version ${t.supported}, but you use ${t.used}`:e==="wrong-subprotocol"?`Only ${t.supported} application subprotocols are supported, but you use ${t.used}`:e==="wrong-credentials"?"Wrong credentials":e}}async function Z(i,e,t,s){if(!i.options.auth){i.authenticated=!0,s();return}try{if(await i.options.auth(e,t,i.remoteHeaders)){i.authenticated=!0,s();for(let o=0;o<i.unauthenticated.length;o++)i.onMessage(i.unauthenticated[o]);i.unauthenticated=[]}else i.sendError(new w("wrong-credentials")),i.destroy()}catch(n){n.name==="LoguxError"?(i.sendError(n),i.destroy()):i.error(n)}}function $(i,e){return i.remoteProtocol=e,e>=i.minProtocol?!0:(i.sendError(new w("wrong-protocol",{supported:i.minProtocol,used:e})),i.destroy(),!1)}function _(i){try{i.emitter.emit("connect")}catch(e){if(e.name==="LoguxError")return i.sendError(e),!1;throw e}return!0}async function re(){let i=["connect",this.localProtocol,this.localNodeId,this.lastReceived],e={};this.options.token&&(typeof this.options.token=="function"?e.token=await this.options.token():e.token=this.options.token),this.options.subprotocol&&(e.subprotocol=this.options.subprotocol),Object.keys(e).length>0&&i.push(e),this.options.fixTime&&(this.connectSended=this.now()),Object.keys(this.localHeaders).length>0&&this.sendHeaders(this.localHeaders),this.startTimeout(),this.send(i)}async function de(i,e){let t=["connected",this.localProtocol,this.localNodeId,[i,e]],s={};this.options.token&&(typeof this.options.token=="function"?s.token=await this.options.token():s.token=this.options.token),this.options.subprotocol&&(s.subprotocol=this.options.subprotocol),Object.keys(s).length>0&&t.push(s),Object.keys(this.localHeaders).length>0&&this.sendHeaders(this.localHeaders),this.send(t)}function le(i,e,t,s){let n=this.now();if(s||(s={}),this.remoteNodeId=e,!!$(this,i)){if(this.remoteSubprotocol=s.subprotocol||"0.0.0",!_(this)){this.destroy();return}Z(this,e,s.token,()=>{this.baseTime=this.now(),this.sendConnected(n,this.baseTime),this.syncSince(t)})}}function Ae(i,e,t,s){if(s||(s={}),this.endTimeout(),this.remoteNodeId=e,!!$(this,i)){if(this.baseTime=t[1],this.options.fixTime){let n=this.now(),o=t[1]-t[0],d=n-this.connectSended-o;this.timeFix=Math.floor(this.connectSended-t[0]+d/2)}if(this.remoteSubprotocol=s.subprotocol||"0.0.0",!_(this)){this.destroy();return}Z(this,e,s.token,()=>{this.syncSince(this.lastSent)})}}function ce(i,e){this.send(["debug",i,e])}function he(i,e){this.emitter.emit("debug",i,e)}function ae(i){let e=["error",i.type];typeof i.options<"u"&&e.push(i.options),this.send(e),this.emitter.emit("clientError",i)}function ue(i,e){this.syncError(i,e,!0)}function ge(i){this.send(["headers",i])}function fe(i){this.remoteHeaders=i,this.emitter.emit("headers",i)}function pe(){this.startTimeout(),this.send(["ping",this.lastAddedCache]),this.pingTimeout&&clearTimeout(this.pingTimeout)}function me(i){this.setLastReceived(i),this.connected&&this.authenticated&&this.send(["pong",this.lastAddedCache])}function ye(i){this.setLastReceived(i),this.endTimeout()}function be(i,e){this.startTimeout();let t=[];for(let[s,n]of e){let o={};for(let d in n)d==="id"?o.id=n.id.split(" "):d!=="added"&&(o[d]=n[d]);this.timeFix&&(o.time-=this.timeFix),o.id[0]=parseInt(o.id[0])-this.baseTime,o.id[2]=parseInt(o.id[2]),o.time-=this.baseTime,o.id[1]===this.localNodeId&&(o.id[2]===0?o.id=o.id[0]:o.id=[o.id[0],o.id[2]]),t.unshift(s,o)}this.syncing+=1,this.setState("sending"),this.send(["sync",i].concat(t))}function Ie(i){this.send(["synced",i])}async function we(i,...e){for(let t=0;t<e.length-1;t+=2){let s=e[t],n=e[t+1];typeof n.id=="number"?n.id=n.id+this.baseTime+" "+this.remoteNodeId+" 0":(n.id[0]=n.id[0]+this.baseTime,n.id.length===2?n.id=n.id[0]+" "+this.remoteNodeId+" "+n.id[1]:n.id=n.id.join(" ")),n.time=n.time+this.baseTime,this.timeFix&&(n.time=n.time+this.timeFix),this.options.onReceive?De(this,s,n):ee(this,s,n)}this.setLastReceived(i),this.sendSynced(i)}async function De(i,e,t){try{let s=await i.options.onReceive(e,t);s&&ee(i,s[0],s[1])}catch(s){i.error(s)}}function ee(i,e,t){return i.received&&(i.received[t.id]=!0),i.log.add(e,t)}function Ce(i){this.endTimeout(),this.setLastSent(i),this.syncing>0&&(this.syncing-=1),this.syncing===0&&this.setState("synchronized")}const Se={timeout:!0,"wrong-protocol":!0,"wrong-subprotocol":!0},ve=["connect","connected","error","debug","headers"];function U(i,e,t,s){if(typeof s>"u"){let n=i.lastAddedCache;s=n>i.lastSent?n:i.lastSent}i.sendSync(s,[[e,t]])}class f{constructor(e,t,s,n={}){if(this.remoteNodeId=void 0,this.remoteProtocol=void 0,this.remoteSubprotocol=void 0,this.minProtocol=3,this.localProtocol=4,this.localNodeId=e,this.log=t,this.connection=s,this.options=n,this.options.ping&&!this.options.timeout)throw new Error("You must set timeout option to use ping");this.connected=!1,this.authenticated=!1,this.unauthenticated=[],this.timeFix=0,this.syncing=0,this.received={},this.lastSent=0,this.lastReceived=0,this.state="disconnected",this.emitter=T(),this.timeouts=[],this.throwsError=!0,this.unbind=[t.on("add",(o,d)=>{this.onAdd(o,d)}),s.on("connecting",()=>{this.onConnecting()}),s.on("connect",()=>{this.onConnect()}),s.on("message",o=>{this.onMessage(o)}),s.on("error",o=>{o.message==="Wrong message format"?(this.sendError(new w("wrong-format",o.received)),this.connection.disconnect("error")):this.error(o)}),s.on("disconnect",()=>{this.onDisconnect()})],this.initialized=!1,this.lastAddedCache=0,this.initializing=this.initialize(),this.localHeaders={},this.remoteHeaders={}}catch(e){this.throwsError=!1;let t=this.on("error",e);return()=>{this.throwsError=!0,t()}}delayPing(){this.options.ping&&(this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{this.connected&&this.authenticated&&this.sendPing()},this.options.ping))}destroy(){this.connection.destroy?this.connection.destroy():this.connected&&this.connection.disconnect("destroy");for(let e of this.unbind)e();clearTimeout(this.pingTimeout),this.endTimeout()}duilianMessage(e){P[e]&&this.send(["duilian",P[e]])}endTimeout(){this.timeouts.length>0&&clearTimeout(this.timeouts.shift())}error(e){if(this.emitter.emit("error",e),this.connection.disconnect("error"),this.throwsError)throw e}async initialize(){let[e,t]=await Promise.all([this.log.store.getLastSynced(),this.log.store.getLastAdded()]);this.initialized=!0,this.lastSent=e.sent,this.lastReceived=e.received,this.lastAddedCache=t,this.connection.connected&&this.onConnect()}now(){return Date.now()}on(e,t){return this.emitter.on(e,t)}async onAdd(e,t){if(this.authenticated){if(this.lastAddedCache<t.added&&(this.lastAddedCache=t.added),this.received&&this.received[t.id]){delete this.received[t.id];return}if(this.options.onSend)try{let s=t.added,n=await this.options.onSend(e,t);n&&U(this,n[0],n[1],s)}catch(s){this.error(s)}else U(this,e,t,t.added)}}onConnect(){this.delayPing(),this.connected=!0}onConnecting(){this.setState("connecting")}onDisconnect(){for(;this.timeouts.length>0;)this.endTimeout();this.pingTimeout&&clearTimeout(this.pingTimeout),this.authenticated=!1,this.connected=!1,this.syncing=0,this.setState("disconnected")}onMessage(e){this.delayPing();let t=e[0];if(!this.authenticated&&!ve.includes(t)){this.unauthenticated.push(e);return}this[t+"Message"](...e.slice(1))}send(e){if(this.connected){this.delayPing();try{this.connection.send(e)}catch(t){this.error(t)}}}sendDuilian(){this.send(["duilian",Object.keys(P)[0]])}setLastReceived(e){this.lastReceived<e&&(this.lastReceived=e),this.log.store.setLastSynced({received:e})}setLastSent(e){this.lastSent<e&&(this.lastSent=e,this.log.store.setLastSynced({sent:e}))}setLocalHeaders(e){this.localHeaders=e,this.connected&&this.sendHeaders(e)}setState(e){this.state!==e&&(this.state=e,this.emitter.emit("state"))}startTimeout(){if(!this.options.timeout)return;let e=this.options.timeout,t=setTimeout(()=>{this.connected&&this.connection.disconnect("timeout"),this.syncError("timeout",e)},e);this.timeouts.push(t)}syncError(e,t,s){let n=new w(e,t,s);if(this.emitter.emit("error",n),!Se[e]&&this.throwsError)throw n}syncFilter(){return!0}async syncSince(e){let t=await this.syncSinceQuery(e);this.connected&&(t.entries.length>0?this.sendSync(t.added,t.entries):this.setState("synchronized"))}async syncSinceQuery(e){let t=[],s=0;await this.log.each({order:"added"},(o,d)=>{if(d.added<=e)return!1;if(this.syncFilter(o,d))return this.options.onSend?t.push((async()=>{try{let A=await this.options.onSend(o,d);return A&&d.added>s&&(s=d.added),A}catch(A){return this.error(A),!1}})()):(d.added>s&&(s=d.added),t.push(Promise.resolve([o,d]))),!0});let n=await Promise.all(t);return{added:s,entries:n.filter(o=>o!==!1)}}waitFor(e){return this.state===e?Promise.resolve():new Promise(t=>{let s=this.on("state",()=>{this.state===e&&(s(),t())})})}}f.prototype.sendConnect=re;f.prototype.sendConnected=de;f.prototype.connectMessage=le;f.prototype.connectedMessage=Ae;f.prototype.sendSync=be;f.prototype.sendSynced=Ie;f.prototype.syncMessage=we;f.prototype.syncedMessage=Ce;f.prototype.sendPing=pe;f.prototype.pingMessage=me;f.prototype.pongMessage=ye;f.prototype.sendDebug=ce;f.prototype.debugMessage=he;f.prototype.sendError=ae;f.prototype.errorMessage=ue;f.prototype.sendHeaders=ge;f.prototype.headersMessage=fe;const P={金木水火土:"板城烧锅酒"},q={fixTime:!0,ping:1e4,timeout:7e4};class te extends f{constructor(e,t,s,n={}){super(e,t,s,{...n,fixTime:n.fixTime??q.fixTime,ping:n.ping??q.ping,timeout:n.timeout??q.timeout})}onConnect(){this.connected||(this.connected=!0,this.initializing=this.initializing.then(()=>{this.connected&&this.sendConnect()}))}}function S(i,e){if(i&&!e)return!1;if(!i&&e)return!0;if(typeof i=="string"&&(i={id:i,time:parseInt(i)}),typeof e=="string"&&(e={id:e,time:parseInt(e)}),i.time>e.time)return!1;if(i.time<e.time)return!0;let t=i.id.split(" "),s=e.id.split(" "),n=t[1],o=s[1];if(n>o)return!1;if(n<o)return!0;let d=parseInt(t[2]),A=parseInt(s[2]);if(d>A)return!1;if(d<A)return!0;let r=parseInt(t[0]),h=parseInt(s[0]);return r>h?!1:r<h}class X{constructor(e,t){this.connecting=!1,this.connected=!1,this.emitter=T(),this.type=t,this.pair=e}connect(){if(this.connected)throw new Error("Connection already established");return this.connecting=!0,this.emitter.emit("connecting"),new Promise(e=>{setTimeout(()=>{if(!this.connecting){e();return}this.other().connected=!0,this.connected=!0,this.connecting=!1,this.other().emitter.emit("connect"),this.emitter.emit("connect"),e()},this.pair.delay)})}disconnect(e){if(this.connecting)return this.connecting=!1,this.emitter.emit("disconnect",e),Promise.resolve();if(this.connected)return this.connected=!1,this.emitter.emit("disconnect",e),new Promise(t=>{setTimeout(()=>{this.other().connected=!1,this.other().emitter.emit("disconnect"),t()},1)});throw new Error("Connection already finished")}on(e,t){return this.emitter.on(e,t)}other(){return this.type==="left"?this.pair.right:this.pair.left}send(e){if(this.connected)setTimeout(()=>{this.other().emitter.emit("message",e)},this.pair.delay);else throw new Error("Connection should be started before sending a message")}}class xe{constructor(e=1){this.delay=e,this.left=new X(this,"left"),this.right=new X(this,"right")}}function I(i,e,t,s){t.id&&i.emit(`${e}-${t.type}-${t.id}`,t,s),i.emit(`${e}-${t.type}-`,t,s),i.emit(e,t,s)}class ie{constructor(e={}){this.nodeId=e.nodeId,this.lastTime=0,this.sequence=0,this.store=e.store,this.emitter=T()}async add(e,t={}){if(typeof e.type>"u")throw new Error('Expected "type" in action');let s=!1;if(typeof t.id>"u"&&(s=!0,t.id=this.generateId()),typeof t.time>"u"&&(t.time=parseInt(t.id)),typeof t.reasons>"u"&&(t.reasons=[]),I(this.emitter,"preadd",e,t),t.keepLast&&(this.removeReason(t.keepLast,{olderThan:t}),t.reasons.push(t.keepLast)),t.reasons.length===0&&s)return I(this.emitter,"add",e,t),I(this.emitter,"clean",e,t),t;if(t.reasons.length===0){let[n]=await this.store.byId(t.id);return n?!1:(I(this.emitter,"add",e,t),I(this.emitter,"clean",e,t),t)}else{let n=await this.store.add(e,t);return n===!1?!1:(I(this.emitter,"add",e,t),n)}}byId(e){return this.store.byId(e)}async changeMeta(e,t){for(let s in t)if(s==="id"||s==="added"||s==="time"||s==="subprotocol"||s==="indexes")throw new Error('Meta "'+s+'" is read-only');if(t.reasons&&t.reasons.length===0){let s=await this.store.remove(e);if(s){for(let n in t)s[1][n]=t[n];I(this.emitter,"clean",s[0],s[1])}return!!s}else return this.store.changeMeta(e,t)}each(e,t){t||(t=e,e={order:"created"});let s=this.store;return new Promise(n=>{async function o(d){let A=await d(),r;for(let h=A.entries.length-1;h>=0;h--){let l=A.entries[h];if(r=t(l[0],l[1]),r===!1)break}r===!1||!A.next?n():o(A.next)}o(s.get.bind(s,e))})}generateId(){let e=Date.now();return e<=this.lastTime?(e=this.lastTime,this.sequence+=1):(this.lastTime=e,this.sequence=0),e+" "+this.nodeId+" "+this.sequence}on(e,t){return this.emitter.on(e,t)}removeReason(e,t={}){return this.store.removeReason(e,t,(s,n)=>{I(this.emitter,"clean",s,n)})}type(e,t,s={}){let n=s.event||"add",o=s.id||"";return this.emitter.on(`${n}-${e}-${o}`,t)}}function K(i,e){i.indexes[e]||(i.indexes[e]={added:[],entries:[]})}function C(i,e){let t=i.indexes;if(x(t)&&t.length>0)for(let s of t)e(s)}function Q(i,e){return i.lastAdded+=1,e[1].added=i.lastAdded,i.added.push(e),C(e[1],t=>{K(i,t),i.indexes[t].added.push(e)}),Promise.resolve(e[1])}function M(i,e){let t=e.added,s=0,n=i.added.length-1;for(;s<=n;){let o=n+s>>1,d=i.added[o][1].added;if(d<t)s=o+1;else if(d>t)n=o-1;else{i.added.splice(o,1);break}}}function v(i,e){for(let t=i.length-1;t>=0;t--)if(e===i[t][1].id)return t;return-1}function x(i){return typeof i<"u"}class se{constructor(){this.entries=[],this.added=[],this.indexes={},this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async add(e,t){let s=[e,t],n=t.id,o=this.entries;for(let d=0;d<o.length;d++){let[,A]=o[d];if(n===A.id)return!1;if(!S(A,t))return C(t,r=>{K(this,r);let h=this.indexes[r].entries,l=h.findIndex(c=>!S(c[1],t));h.splice(l,0,s)}),o.splice(d,0,s),Q(this,s)}return C(t,d=>{K(this,d),this.indexes[d].entries.push(s)}),o.push(s),Q(this,s)}async byId(e){let t=v(this.entries,e);if(t===-1)return[null,null];{let[s,n]=this.entries[t];return[s,n]}}async changeMeta(e,t){let s=v(this.entries,e);if(s===-1)return!1;{let n=this.entries[s][1];for(let o in t)n[o]=t[o];return!0}}async clean(){this.entries=[],this.added=[],this.indexes={},this.lastReceived=0,this.lastAdded=0,this.lastSent=0}async get(e={}){let t=e.index,s=this,n;return t&&(s=this.indexes[t]||{added:[],entries:[]}),e.order==="created"?n=s.entries:n=s.added,{entries:n.slice(0)}}async getLastAdded(){return this.lastAdded}async getLastSynced(){return{received:this.lastReceived,sent:this.lastSent}}async remove(e,t){if(typeof t>"u"&&(t=v(this.entries,e),t===-1))return Promise.resolve(!1);let s=[this.entries[t][0],this.entries[t][1]];return C(s[1],n=>{let o=this.indexes[n].entries,d=v(o,e);d!==-1&&o.splice(d,1)}),this.entries.splice(t,1),C(s[1],n=>{M(this.indexes[n],s[1])}),M(this,s[1]),s}async removeReason(e,t,s){let n=[];if(t.id){let o=v(this.entries,t.id);if(o!==-1){let d=this.entries[o][1],A=d.reasons.indexOf(e);A!==-1&&(d.reasons.splice(A,1),d.reasons.length===0&&(s(this.entries[o][0],d),this.remove(t.id)))}}else{this.entries=this.entries.filter(([A,r])=>{let h=t,l=r.reasons.indexOf(e);return l===-1||x(h.olderThan)&&!S(r,h.olderThan)||x(h.youngerThan)&&!S(h.youngerThan,r)||x(h.minAdded)&&r.added<h.minAdded||x(h.maxAdded)&&r.added>h.maxAdded?!0:(r.reasons.splice(l,1),r.reasons.length===0?(s(A,r),n.push(r),!1):!0)});let o=n.map(A=>A.added),d=A=>!o.includes(A[1].added);this.added=this.added.filter(d);for(let A of n)C(A,r=>{this.indexes[r].entries=this.indexes[r].entries.filter(d),this.indexes[r].added=this.indexes[r].added.filter(d)})}}async setLastSynced(e){typeof e.sent<"u"&&(this.lastSent=e.sent),typeof e.received<"u"&&(this.lastReceived=e.received)}}function N(i){i.includes(" ")&&(i=i.split(" ")[1]);let e=i.split(":");if(e.length===1)return{clientId:i,nodeId:i,userId:void 0};{let t=e[0];return{clientId:e[0]+":"+e[1],nodeId:i,userId:t}}}const O={attempts:1/0,maxDelay:5e3,minDelay:1e3},Ee=["wrong-protocol","wrong-subprotocol","wrong-credentials"];class Te{constructor(e,{attempts:t=O.attempts,maxDelay:s=O.maxDelay,minDelay:n=O.minDelay}={}){this.connection=e,this.options={attempts:t,maxDelay:s,minDelay:n},this.reconnecting=e.connected,this.beforeFreeze=null,this.connecting=!1,this.attempts=0,this.unbind=[this.connection.on("message",h=>{h[0]==="error"&&Ee.includes(h[1])&&(this.reconnecting=!1)}),this.connection.on("connecting",()=>{this.connecting=!0}),this.connection.on("connect",()=>{this.attempts=0,this.connecting=!1}),this.connection.on("disconnect",()=>{this.connecting=!1,this.reconnecting&&this.reconnect()}),()=>{clearTimeout(this.timer)}];let o=()=>{this.reconnecting&&!this.connected&&!this.connecting&&typeof document<"u"&&!document.hidden&&this.connect()},d=()=>{this.reconnecting&&!this.connected&&!this.connecting&&navigator.onLine&&this.connect()},A=()=>{this.beforeFreeze!==null&&(this.reconnecting=this.beforeFreeze,this.beforeFreeze=null),d()},r=()=>{this.beforeFreeze===null&&(this.beforeFreeze=this.reconnecting,this.reconnecting=!1),this.disconnect("freeze")};typeof document<"u"&&typeof window<"u"&&document.addEventListener&&window.addEventListener&&(document.addEventListener("visibilitychange",o,!1),window.addEventListener("focus",d,!1),window.addEventListener("online",d,!1),window.addEventListener("resume",A,!1),window.addEventListener("freeze",r,!1),this.unbind.push(()=>{document.removeEventListener("visibilitychange",o,!1),window.removeEventListener("focus",d,!1),window.removeEventListener("online",d,!1),window.removeEventListener("resume",A,!1),window.removeEventListener("freeze",r,!1)}))}connect(){return this.attempts+=1,this.reconnecting=!0,this.connection.connect()}destroy(){for(let e of this.unbind)e();this.disconnect("destroy")}disconnect(e){return e!=="timeout"&&e!=="error"&&e!=="freeze"&&(this.reconnecting=!1),this.connection.disconnect(e)}nextDelay(){let e=this.options.minDelay*2**this.attempts,t=Math.random(),s=t*.5*e;return Math.floor(t*10)===1&&(s=-s),Math.min(e+s,this.options.maxDelay)||0}on(...e){return this.connection.on(...e)}reconnect(){if(this.attempts>this.options.attempts-1){this.reconnecting=!1,this.attempts=0;return}let e=this.nextDelay();this.timer=setTimeout(()=>{this.reconnecting&&!this.connecting&&!this.connected&&this.connect()},e)}send(...e){return this.connection.send(...e)}get connected(){return this.connection.connected}get emitter(){return this.connection.emitter}}class ke{constructor(e,t,s){if(this.connected=!1,this.emitter=T(),t)this.Class=t;else if(typeof WebSocket<"u")this.Class=WebSocket;else throw new Error("No WebSocket support");this.url=e,this.opts=s}connect(){return this.ws?Promise.resolve():(this.emitter.emit("connecting"),this.init(new this.Class(this.url,void 0,this.opts)),new Promise(e=>{this.ws.onopen=()=>{this.connected=!0,this.emitter.emit("connect"),e()}}))}disconnect(){this.ws&&(this.ws.onclose=void 0,this.ws.close(),this.onclose())}error(e){let t=new Error("Wrong message format");t.received=e,this.emitter.emit("error",t)}init(e){e.onerror=t=>{this.emitter.emit("error",t.error||new Error("WS Error"))},e.onclose=()=>{this.onclose()},e.onmessage=t=>{let s;try{s=JSON.parse(t.data)}catch{this.error(t.data);return}this.emitter.emit("message",s)},this.ws=e}on(e,t){return this.emitter.on(e,t)}onclose(){this.ws&&(this.connected=!1,this.emitter.emit("disconnect"),this.ws=void 0)}send(e){this.ws&&this.ws.readyState===this.ws.OPEN?this.ws.send(JSON.stringify(e)):this.emitter.emit("error",new Error("WS was closed"))}}const Le="data:image/svg+xml,%3csvg%20viewBox='13%2014%2024%2024'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M20%2029h-1a4%204%200%2001-.998-7.874%205%205%200%20019.333-2.621%203%203%200%20014.49%203.51A3.5%203.5%200%200131.499%2029H30v2h1.5a5.5%205.5%200%20002.484-10.408%205%205%200%2000-5.985-4.492%207.003%207.003%200%2000-11.886%203.64A6%206%200%200019%2031h1v-2zm6-6.502l-5%208.451%204%20.025-2%206.546%206-8.483-4-.011%201-6.528z'%20fill='%23FFF'/%3e%3c/svg%3e",Y="data:image/svg+xml,%3csvg%20viewBox='15%2014%2020%2021'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M17.932%2032.068l1.414-1.414A7.975%207.975%200%200025%2033c4.411%200%208-3.589%208-8h2c0%205.514-4.486%2010-10%2010a9.969%209.969%200%2001-7.068-2.932zM15%2025c0-5.514%204.486-10%2010-10a9.969%209.969%200%20017.068%202.932l-1.414%201.414A7.975%207.975%200%200025%2017c-4.411%200-8%203.589-8%208h-2zm18.5-8.5L29%2021l6%202-1.5-6.5zM21%2029l-4.5%204.5L15%2027l6%202zm3-10h2v4l-.5%204h-1l-.5-4v-4zm1%2011a1%201%200%20110-2%201%201%200%20010%202z'%20fill='%23FFF'%20fill-rule='evenodd'/%3e%3c/svg%3e",J="data:image/svg+xml,%3csvg%20viewBox='15%2014%2020%2021'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M17.932%2032.068l1.414-1.414A7.975%207.975%200%200025%2033c4.411%200%208-3.589%208-8h2c0%205.514-4.486%2010-10%2010a9.969%209.969%200%2001-7.068-2.932zM15%2025c0-5.514%204.486-10%2010-10a9.969%209.969%200%20017.068%202.932l-1.414%201.414A7.975%207.975%200%200025%2017c-4.411%200-8%203.589-8%208h-2zm18.5-8.5L29%2021l6%202-1.5-6.5zM21%2029l-4.5%204.5L15%2027l6%202z'%20fill='%23FFF'%20fill-rule='evenodd'/%3e%3c/svg%3e",He="data:image/svg+xml,%3csvg%20viewBox='13%2017%2023%2017'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20stroke='%23FFF'%20stroke-width='2'%20stroke-linecap='square'%20fill='none'%20d='M14.5%2025.5l6.67%206.67L34.5%2018.5'/%3e%3c/svg%3e";let Pe={base:{backgroundPosition:"1.2em center",backgroundRepeat:"no-repeat",backgroundSize:"1.8em",borderRadius:"0.4em",color:"#fff",fontFamily:"Helvetica Neue, sans-serif",height:"4em",lineHeight:"1.4",margin:"1.5em",opacity:"0.8",paddingLeft:"4.2em",position:"fixed",width:"15.4em",zIndex:"999"},disconnected:{backgroundColor:"#000",backgroundImage:"url("+Y+")"},error:{backgroundColor:"#F42A2A",backgroundImage:"url("+Le+")"},protocolError:{backgroundColor:"#000",backgroundImage:"url("+J+")"},sending:{backgroundColor:"#000",backgroundImage:"url("+J+")"},synchronized:{backgroundColor:"#000",backgroundImage:"url("+He+")"},text:{display:"table-cell",height:"4em",verticalAlign:"middle"},wait:{backgroundColor:"#000",backgroundImage:"url("+Y+")"}};function qe(i){let e=document,t=!1,s=[],n=!1,o=()=>{t&&(e.title=t,t=!1)},d=()=>{e.hidden&&!t?(t=e.title,e.title="* "+e.title):o(),e.hidden&&(n=setTimeout(d,1e3))},A=()=>{!e.hidden&&n&&(n=clearTimeout(n),o())};return e&&typeof e.hidden<"u"&&(s.push(i.node.on("error",r=>{r.type!=="timeout"&&!n&&d()})),s.push(i.on("add",r=>{r.type==="logux/undo"&&r.reason&&!n&&d()})),document.addEventListener("visibilitychange",A,!1),s.push(()=>{document.removeEventListener("visibilitychange",A,!1)})),()=>{for(let r of s)r()}}function ne(i,e,t={}){let s=i.on?i:i.node,n=s.state==="disconnected",o=!1,d=!1;typeof t.duration>"u"&&(t.duration=3e3);let A,r=[],h={};function l(){Object.keys(h).length===0&&(o?(o=!1,e("synchronizedAfterWait"),A=setTimeout(()=>{e("synchronized")},t.duration)):e("synchronized"))}function c(){clearTimeout(A),!d&&(s.state==="disconnected"?(n=!0,e(o?"wait":"disconnected")):s.state==="synchronized"?(n=!1,l()):s.state==="connecting"?A=setTimeout(()=>{e("connecting"+(o?"AfterWait":""))},100):e(i.state+(o?"AfterWait":"")))}r.push(s.on("state",c)),r.push(i.node.on("error",a=>{a.type==="wrong-protocol"||a.type==="wrong-subprotocol"?(d=!0,e("protocolError")):a.type!=="timeout"&&e("syncError",{error:a})})),r.push(i.node.on("clientError",a=>{e("syncError",{error:a})}));let g=i.on?i:i.log;return r.push(g.on("add",(a,p)=>{a.type!=="logux/subscribe"&&a.type!=="logux/unsubscribe"&&(a.type==="logux/processed"?(delete h[a.id],l()):a.type==="logux/undo"?delete h[a.id]:p.sync&&(h[p.id]=!0),a.type==="logux/undo"&&a.reason?a.reason==="denied"?e("denied",{action:a,meta:p}):e("error",{action:a,meta:p}):n&&p.sync&&p.added&&(o||e("wait"),o=!0))})),c(),()=>{for(let a of r)a()}}function L(i,e){for(let t in e)i.style[t]=e[t]}function Oe(i,e){let t=i.style;e==="middle-center"||e==="center-middle"?(t.top="50%",t.left="50%",t.transform="translate(-50%, -50%)"):e.split("-").forEach(s=>{s==="middle"?(t.top="50%",t.transform="translateY(-50%)"):s==="center"?(t.left="50%",t.transform="translateX(-50%)"):t[s]="0"})}const Re={boxSizing:"content-box",fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",letterSpacing:"normal",lineHeight:"auto",textIndent:"0",textTransform:"none",visibility:"visible",wordSpacing:"normal"};function Ke(i,e){let t=e.messages,s=e.position||"bottom-right",n=e.styles,o=document.createElement("div"),d=document.createElement("span");o.setAttribute("role","alert"),L(o,Re),L(o,n.base),L(d,n.text),Oe(o,s);let A=(l,c)=>{d.innerHTML=c,L(o,l),o.style.display="block"},r=()=>{o.style.display="none"},h=ne(i,l=>{l==="sendingAfterWait"||l==="connectingAfterWait"?A(n.sending,t.sending):l==="synchronizedAfterWait"?A(n.synchronized,t.synchronized):l==="synchronized"?r():l==="disconnected"?A(n.disconnected,t.disconnected):l==="wait"?A(n.wait,t.wait):l==="protocolError"?A(n.protocolError,t.protocolError):l==="syncError"?A(n.error,t.syncError):l==="error"?A(n.error,t.error):l==="denied"&&A(n.error,t.denied)},e);return o.appendChild(d),document.body.appendChild(o),()=>{h(),document.body.removeChild(o)}}let Ne={denied:"You have no access<br>You changes was reverted",disconnected:"No Internet connection",error:"Server error<br>You changes was reverted",protocolError:"Saving is not working<br>Refresh the page",sending:"Data saving",syncError:"Server error<br>Your data has not been saved",synchronized:"Your data has been saved",wait:"No Internet connection<br>Your data has not been saved"};const Ge="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let R=(i=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(i));for(;i--;)e+=Ge[t[i]&63];return e};class Fe extends Error{constructor(e){let t=e.action?e.action.type:"action";super(`Server undid ${t} because of ${e.reason}`),this.name="LoguxUndoError",this.action=e}}function Be(i,e){if(i.processing[e])return i.processing[e][0];let t,s,n=new Promise((o,d)=>{s=o,t=d});return i.processing[e]=[n,s,t],n}let Ue=["id","time","subprotocol"];function W(i){localStorage.setItem(i.options.prefix+":tab:"+i.tabId,Date.now())}function j(i,e){i.log.removeReason("tab"+e).then(()=>{i.isLocalStorage&&localStorage.removeItem(i.options.prefix+":tab:"+e)})}function Xe(i,e){return!i&&!e?!0:JSON.stringify(i)===JSON.stringify(e)}function z(i,e){let t=JSON.stringify({...e,type:"logux/subscribe"}),s=i.subscriptions[t];s&&(s===1?delete i.subscriptions[t]:i.subscriptions[t]=s-1)}class Qe{constructor(e={}){if(this.options=e,typeof this.options.prefix>"u"&&(this.options.prefix="logux"),this.isLocalStorage=!1,typeof localStorage<"u"){let l=R();try{localStorage.setItem(l,"1"),localStorage.removeItem(l),this.isLocalStorage=!0}catch{}}this.options.time?(this.tabId=this.options.time.lastId+1+"",this.clientId=this.options.userId+":"+this.tabId):(this.clientId=this.options.userId+":"+this.getClientId(),this.tabId=R(8)),this.nodeId=this.clientId+":"+this.tabId;let t=this.options.store||new se,s;this.options.time?s=this.options.time.nextLog({nodeId:this.nodeId,store:t}):s=new ie({nodeId:this.nodeId,store:t}),this.log=s,this.last={},this.subscriptions={};let n={},o={};s.on("preadd",(l,c)=>{if(N(c.id).nodeId===this.nodeId&&!c.subprotocol&&(c.subprotocol=this.options.subprotocol),l.type==="logux/unsubscribe"){let g=!0,a=!1;for(let p in n){let D=n[p];if(D.channel===l.channel&&Xe(l.filer,D.filter)){g=!1,delete n[p],s.changeMeta(p,{reasons:[]});break}}g&&this.state==="disconnected"&&(a=!0,z(this,l)),g&&!a?c.sync=!0:delete c.sync}c.sync&&!c.resubscribe&&c.reasons.push("syncing")}),this.emitter=T(),this.on("add",(l,c)=>{let g=l.type,a;if((g==="logux/processed"||g==="logux/undo")&&this.log.removeReason("syncing",{id:l.id}),g==="logux/subscribe"&&!c.resubscribe)n[c.id]=l;else if(g==="logux/unsubscribe")c.sync&&(o[c.id]=l);else if(g==="logux/processed"){if(o[l.id])z(this,o[l.id]);else if(n[l.id]){let p=n[l.id];delete n[l.id];let D=JSON.stringify(p);this.subscriptions[D]?this.subscriptions[D]+=1:this.subscriptions[D]=1,a=this.last[p.channel],(!a||S(a,c))&&(this.last[p.channel]={id:c.id,time:c.time})}this.processing[l.id]&&(this.processing[l.id][1](c),delete this.processing[l.id])}else g==="logux/undo"?(this.processing[l.id]&&(this.processing[l.id][2](new Fe(l)),delete this.processing[l.id]),delete n[l.id],delete o[l.id]):c.channels&&(c.id.includes(" "+this.clientId+":")||c.channels.forEach(p=>{a=this.last[p],(!a||S(a,c))&&(this.last[p]={id:c.id,time:c.time})}))}),this.tabPing=6e4,this.tabTimeout=10*this.tabPing;let d="tab"+this.tabId;if(this.isLocalStorage){let l=s.on("add",(c,g)=>{g.reasons.includes(d)&&(W(this),this.pinging=setInterval(()=>{W(this)},this.tabPing),l())})}let A;if(typeof this.options.server=="string"){let l=new ke(this.options.server);A=new Te(l,{attempts:this.options.attempts,maxDelay:this.options.maxDelay,minDelay:this.options.minDelay})}else A=this.options.server;let r=async(l,c)=>{if(c.sync&&N(c.id).userId===this.options.userId){let g={};for(let a in c)a==="subprotocol"?c.subprotocol!==this.options.subprotocol&&(g.subprotocol=c.subprotocol):Ue.includes(a)&&(g[a]=c[a]);return[l,g]}else return!1};if(this.node=new te(this.nodeId,this.log,A,{fixTime:!this.options.time,onSend:r,ping:this.options.ping,subprotocol:this.options.subprotocol,timeout:this.options.timeout,token:this.options.token}),/^ws:\/\//.test(this.options.server)&&!e.allowDangerousProtocol){let l=this.node.on("state",()=>{this.node.state==="synchronized"&&(l(),this.node.remoteHeaders.env!=="development"&&(console.error("Without SSL, old proxies block WebSockets. Use WSS for Logux or set allowDangerousProtocol option."),this.destroy()))})}this.node.on("debug",(l,c)=>{l==="error"&&console.error(`Error on Logux server:
`,c)});let h=!0;this.node.on("state",()=>{if(this.node.state==="synchronized"){if(h){h=!1;for(let c in this.subscriptions){let g=JSON.parse(c),a=this.last[g.channel];a&&(g.since=a),this.log.add(g,{resubscribe:!0,sync:!0})}}}else this.node.state==="disconnected"&&(h=!0)}),this.onUnload=this.onUnload.bind(this),typeof window<"u"&&window.addEventListener&&window.addEventListener("pagehide",this.onUnload),this.processing={}}changeUser(e,t){let s=this.node.connected;s&&this.node.connection.disconnect("destroy"),this.options.userId=e,this.options.token=t,this.clientId=e+":"+this.getClientId(),this.nodeId=this.clientId+":"+this.tabId,this.log.nodeId=this.nodeId,this.node.localNodeId=this.nodeId,this.node.options.token=t,this.emitter.emit("user",e),s&&this.node.connection.connect()}clean(){return this.destroy(),this.log.store.clean?this.log.store.clean():Promise.resolve()}cleanPrevActions(){if(this.isLocalStorage)for(let e in localStorage){let t=this.options.prefix+":tab:";if(e.slice(0,t.length)===t){let s=parseInt(localStorage.getItem(e));Date.now()-s>this.tabTimeout&&j(this,e.slice(t.length))}}}destroy(){this.onUnload(),this.node.destroy(),clearInterval(this.pinging),typeof window<"u"&&window.removeEventListener&&window.removeEventListener("pagehide",this.onUnload)}getClientId(){return R(8)}on(e,t){return e==="state"?this.node.emitter.on(e,t):e==="user"?this.emitter.on(e,t):this.log.emitter.on(e,t)}onUnload(){this.pinging&&j(this,this.tabId)}start(e=!0){this.cleanPrevActions(),e&&this.node.connection.connect()}sync(e,t={}){return t.sync=!0,typeof t.id>"u"&&(t.id=this.log.generateId()),this.log.add(e,t),Be(this,t.id)}type(e,t,s){return typeof e=="function"&&(e=e.type),this.log.type(e,t,s)}waitFor(e){return this.state===e?Promise.resolve():new Promise(t=>{let s=this.on("state",()=>{this.state===e&&(s(),t())})})}get connected(){return this.state!=="disconnected"&&this.state!=="connecting"}get state(){return this.node.state}}function V(i){return i.returnValue="unsynced","unsynced"}function Me(i){let e=i.state==="disconnected",t=!1,s=()=>{i.state==="disconnected"?e=!0:i.state==="synchronized"&&(e=!1,t=!1),typeof window<"u"&&window.addEventListener&&(i.role!=="follower"&&t&&e?window.addEventListener("beforeunload",V):window.removeEventListener("beforeunload",V))},n=[];return n.push(i.on("role",s)),n.push(i.on("state",s)),s(),n.push(i.on("add",(o,d)=>{o.type!=="logux/subscribe"&&o.type!=="logux/unsubscribe"&&e&&d.sync&&d.added&&(t=!0,s())})),()=>{for(let o of n)o()}}function b(i,e){return i.options.prefix+":"+i.options.userId+":"+e}function E(i,e,t){if(!i.isLocalStorage)return;let s=b(i,e),n=JSON.stringify(t);try{localStorage.setItem(s,n)}catch(o){console.error(o),i.isLocalStorage=!1,i.role="leader",i.emitter.emit("role"),i.autoconnect&&i.node.connection.connect()}}function Ye(i,e){let t=i.split("."),s=e.split(".");for(let n=0;n<3;n++){let o=parseInt(t[n]||0),d=parseInt(s[n]||0);if(o>d)return 1;if(o<d)return-1}return 0}function Je(i,e){i.state=e,i.emitter.emit("state"),E(i,"state",i.state)}function We(i){return Array.isArray(i.entries)&&Array.isArray(i.added)}class je extends Qe{constructor(e={}){if(super(e),this.leaderState=this.node.state,this.role="follower",this.node.on("state",()=>{this.role==="leader"&&Je(this,this.node.state)}),this.log.on("add",(t,s)=>{I(this.emitter,"add",t,s),s.tab!==this.tabId&&E(this,"add",[this.tabId,t,s])}),this.log.on("clean",(t,s)=>{I(this.emitter,"clean",t,s)}),typeof window<"u"&&window.addEventListener&&(window.addEventListener("storage",t=>this.onStorage(t)),window.addEventListener("pagehide",t=>this.onUnload(t))),this.isLocalStorage){let t=b(this,"subprotocol");localStorage.getItem(t)!==this.options.subprotocol&&E(this,"subprotocol",this.options.subprotocol)}}changeUser(e,t){E(this,"user",[this.tabId,e]),super.changeUser(e,t)}clean(){return this.isLocalStorage&&(localStorage.removeItem(b(this,"add")),localStorage.removeItem(b(this,"state")),localStorage.removeItem(b(this,"client"))),super.clean()}destroy(){super.destroy(),this.role="follower",this.emitter.emit("role"),this.unlead&&this.unlead(),typeof window<"u"&&window.removeEventListener&&window.removeEventListener("storage",this.onStorage)}getClientId(){let e=b(this,"client");if(this.isLocalStorage){if(localStorage.getItem(e))return localStorage.getItem(e);{let t=super.getClientId();return localStorage.setItem(e,t),t}}else return super.getClientId()}on(e,t){return e==="preadd"?this.log.emitter.on(e,t):this.emitter.on(e,t)}onStorage(e){if(e.newValue===null)return;let t;if(e.key===b(this,"add")){if(t=JSON.parse(e.newValue),t[0]!==this.tabId){let s=t[1],n=t[2];(!n.tab||n.tab===this.tabId)&&(We(this.log.store)&&this.log.store.add(s,n),I(this.emitter,"add",s,n),this.role==="leader"&&this.node.onAdd(s,n))}}else if(e.key===b(this,"state")){let s=JSON.parse(localStorage.getItem(e.key));this.leaderState!==s&&(this.leaderState=s,this.emitter.emit("state"))}else if(e.key===b(this,"user"))t=JSON.parse(e.newValue),t[0]!==this.tabId&&this.emitter.emit("user",t[1]);else if(e.key===b(this,"subprotocol")){let s=JSON.parse(e.newValue),n=Ye(this.options.subprotocol,s);if(n===1)E(this,"subprotocol",this.options.subprotocol);else if(n===-1){let o=new w("wrong-subprotocol",{supported:s,used:this.options.subprotocol},!0);this.node.emitter.emit("error",o)}}}start(e=!0){if(this.autoconnect=e,this.cleanPrevActions(),typeof navigator>"u"||!navigator.locks||!this.isLocalStorage){this.role="leader",this.emitter.emit("role"),e&&this.node.connection.connect();return}let t=localStorage.getItem(b(this,"state"));t&&t!==null&&t!=='"disconnected"'&&(this.state=JSON.parse(t),this.emitter.emit("state")),navigator.locks.request("logux_leader",()=>(this.role="leader",this.emitter.emit("role"),e&&this.node.connection.connect(),new Promise(s=>{this.unlead=s})))}type(e,t,s={}){if(s.event==="preadd")return this.log.type(e,t,s);{let n=s.event||"add",o=s.id||"";return this.emitter.on(`${n}-${e}-${o}`,t)}}set state(e){this.leaderState=e}get state(){return this.leaderState}}function ze(i,e){let t=e.normal,s=e.offline,n=e.error,o=[],d=document,A=!1,r=!1;function h(){i.connected&&r!==t?A.href=r=t:!i.connected&&s&&r!==s&&r!==n&&(A.href=r=s)}function l(){n&&r!==n&&(A.href=r=n)}return d&&(A=d.querySelector('link[rel~="icon"]'),typeof t>"u"&&(t=A?A.href:""),A||(A=d.createElement("link"),A.rel="icon",A.href="",d.head.appendChild(A)),o.push(i.on("state",h)),h(),o.push(i.on("add",c=>{c.type==="logux/undo"&&c.reason&&l()})),o.push(i.node.on("error",c=>{c.type!=="timeout"&&l()}))),()=>{for(let c of o)c()}}function m(i){return"%c"+i+"%c"}const oe="#c00000";function y(i,e,t){i="%cLogux%c "+i;let s=Array.from(i.match(/%c/g)).map((n,o)=>o===0?t===oe?`color:${t};font-weight:bold`:"color:#ffa200;font-weight:bold":o%2===0?t?`font-weight:bold;color:${t}`:"font-weight:bold":"font-weight:normal");if(e){console.groupCollapsed(i,...s);for(let n in e)typeof e[n]=="string"?console.log(n+": %c"+e[n],"font-weight:bold"):console.log(n,e[n]);console.groupEnd()}else console.log(i,...s)}function Ve(i,e={}){let t=i.node,s={},n=[],o=!1;e.state!==!1&&n.push(i.on("state",()=>{let r;i.state==="connecting"&&t.connection.url?r={"Node ID":t.localNodeId,Server:t.connection.url}:i.connected&&!o&&t.remoteNodeId?(o=!0,r={"Server ID":t.remoteNodeId}):i.connected||(o=!1),y("state is "+m(i.state),r)})),e.role!==!1&&n.push(i.on("role",()=>{y("tab role is "+m(i.role))}));let d={},A=(e.ignoreActions||[]).reduce((r,h)=>(r[h]=!0,r),{});return e.add!==!1&&n.push(i.on("add",(r,h)=>{if(h.tab&&h.tab!==i.tabId||A[r.type])return;h.sync&&(s[h.id]=r);let l;if(r.type==="logux/subscribe")l="subscribing to "+m(r.channel)+" channel",Object.keys(r).length===2?y(l):y(l,{Action:r});else if(r.type==="logux/subscribed")y("subscribed to "+m(r.channel)+" channel by server");else if(r.type==="logux/unsubscribe")l="unsubscribed from channel "+m(r.channel),Object.keys(r).length===2?y(l):y(l,{Action:r});else if(r.type==="logux/processed")if(s[r.id]){let c=s[r.id],g={"Processed Action":c};c.type==="logux/subscribe"?y("subscribed to "+m(c.channel)+" channel",g):y("action "+m(c.type)+" was processed",g),delete s[r.id]}else y("action "+m(r.id)+" was processed");else if(r.type==="logux/undo"){r.action.type==="logux/subscribe"?l="subscription to "+m(r.action.channel):l="action "+m(r.action.type),l+=" was undone because of "+m(r.reason);let c={"Reverted Action":r.action};Object.keys(r).length>4&&(c["Undo Action"]=r),s[r.id]&&delete s[r.id],y(l,c,oe)}else{let c={Action:r,Meta:h};l="added ",h.reasons.length===0&&(d[h.id]=!0,l+="and cleaned "),l+=m(r.type)+" action";let{nodeId:g}=N(h.id);g!==t.localNodeId&&(c.From=g),y(l,c,"#008000")}})),e.user!==!1&&n.push(i.on("user",r=>{let h="user ID was changed to "+m(r);y(h,{"Node ID":i.nodeId})})),e.clean!==!1&&n.push(i.on("clean",(r,h)=>{if(d[h.id]){delete d[h.id];return}if(h.tab&&h.tab!==i.tabId||A[r.type]||r.type.startsWith("logux/"))return;let l="cleaned "+m(r.type)+" action";y(l,{Action:r,Meta:h})})),()=>{for(let r of n)r()}}const Ze="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AADGIKqbAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC",$e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAAAAAAAgAAAmQAAgAAAkgAAiwAAgAAAiQAAgAAAiAAAhwAAgAAAhgAAgAAAhgAAgAAAhQAAgAAAhQAAgAAAhAAAgAAAhAAAgAAAhAAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAggAAgAAAgAAAggAAgAAAggAAgAAAgAAAggAAgAAAggAAgAAAggAAgAAAgQAAgQAAgAAAgQAAgAAAgQAAgQAAgAAAgAAAgQAAgAAAgQAAgAAAgQAAgAAAgAAAgQAAgAAAgQAAgQAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgACYS+jrAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC",_e="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAAAAACAgICZmZmAgICSkpKLi4uAgICJiYmAgICIiIiHh4eAgICGhoaAgICGhoaAgICFhYWAgICFhYWAgICEhISAgICEhISAgICEhISAgICDg4OAgICDg4OAgICDg4OAgICDg4OAgICDg4OAgICCgoKAgICAgICCgoKAgICCgoKAgICAgICCgoKAgICCgoKAgICCgoKAgICBgYGBgYGAgICBgYGAgICBgYGBgYGAgICAgICBgYGAgICBgYGAgICBgYGAgICAgICBgYGAgICBgYGBgYGAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICq+RHaAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC";let F=new xe(500),G=new ie({nodeId:"server:uuid",store:new se});new f("server:uuid",G,F.right);G.on("add",(i,e)=>{i.type!=="logux/processed"&&setTimeout(()=>{G.add({id:e.id,type:"logux/processed"})},500)});let u=new je({server:"wss://example.com/",subprotocol:location.hash.slice(1)||"1.0.0",userId:"10"}),B=new te(u.node.localNodeId,u.log,F.left);B.connection.url="wss://example.com/";B.emitter=u.node.emitter;u.node=B;qe(u);Me(u);ze(u,{error:Ze,normal:$e,offline:_e});Ke(u,{messages:Ne,styles:Pe});Ve(u);ne(u,i=>{document.all.status.innerText=i});let H=0;function et(i){return i==="disconnected"?"😴":i==="connecting"?"🔌":"😊"}function tt(i){return i.slice(0,1).toUpperCase()}function k(){document.title=et(u.state)+" "+tt(u.role)+" "+H}u.on("state",()=>{document.querySelector("#connection").checked=u.connected,k()});u.on("role",()=>{k(),document.querySelector("#connection").disabled=u.role!=="leader"});u.on("add",i=>{i.type==="TICK"&&H++,k()});u.on("clean",i=>{i.type==="TICK"&&H--,k()});u.log.each(i=>{i.type==="TICK"&&H++}).then(()=>{k()});u.on("role",()=>{let i=u.role==="leader";document.all.connection.disabled=!i,document.all.disabled.style.display=i?"none":"inline"});u.start();document.querySelector("#connection").onchange=i=>{i.target.checked?u.node.connection.connect():u.node.connection.disconnect()};document.querySelector("#add").onclick=()=>{u.log.add({type:"TICK"},{reasons:["tick"],sync:!0})};document.querySelector("#clean").onclick=()=>{u.log.removeReason("tick")};document.querySelector("#error").onclick=()=>{setTimeout(()=>{u.log.add({action:{type:"TICK"},reason:"error",type:"logux/undo"})},3e3)};document.querySelector("#denied").onclick=()=>{setTimeout(()=>{u.log.add({action:{type:"TICK"},reason:"denied",type:"logux/undo"})},3e3)};document.querySelector("#serverError").onclick=()=>{setTimeout(()=>{F.right.send(["error","wrong-format"])},3e3)};document.querySelector("#subprotocolError").onclick=()=>{u.node.syncError("wrong-subprotocol",{supported:"2.x",used:"1.0.0"})};u.options.subprotocol==="1.0.1"?document.querySelector("#subprotocolClient").disabled=!0:document.querySelector("#subprotocolClient").onclick=()=>{window.open(location.toString()+"#1.0.1","_blank")};
